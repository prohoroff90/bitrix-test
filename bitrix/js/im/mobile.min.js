(function(){if(BX.ImMobile)return;BX.ImMobile=function(e){BX.browser.addGlobalClass();if(typeof BX.message("USER_TZ_AUTO")=="undefined"||BX.message("USER_TZ_AUTO")=="Y")BX.message({USER_TZ_OFFSET:-(new Date).getTimezoneOffset()*60-parseInt(BX.message("SERVER_TZ_OFFSET"))});if(typeof BX.MessengerCommon!="undefined")BX.MessengerCommon.setBxIm(this);this.mobileVersion=true;this.mobileAction=e.mobileAction?e.mobileAction:"none";this.mobileActionCache=false;this.mobileActionRun=false;this.revision=3;this.errorMessage="";this.bitrixNetwork=e.bitrixNetwork||false;this.bitrixNetwork2=e.bitrixNetwork2||false;this.bitrix24=e.bitrix24||false;this.bitrix24Admin=e.bitrix24Admin||false;this.bitrixIntranet=e.bitrixIntranet||false;this.bitrix24net=e.bitrix24net||false;this.bitrixXmpp=e.bitrixXmpp||false;this.ppStatus=e.ppStatus||false;this.ppServerStatus=this.ppStatus?e.ppServerStatus:false;this.updateStateInterval=e.updateStateInterval||90;this.desktopStatus=e.desktopStatus||false;this.desktopVersion=e.desktopVersion||0;this.xmppStatus=false;this.lastRecordId=0;this.userId=e.userId;this.userEmail=e.userEmail||"";this.path=e.path||{};this.language=e.language||"en";this.init=typeof e.init!="undefined"?e.init:true;this.tryConnect=true;this.animationSupport=true;this.keyboardShow=false;this.sendAjaxTry=0;this.pathToRoot=BX.message("MobileSiteDir")?BX.message("MobileSiteDir"):"/";this.pathToAjax=this.pathToRoot+"mobile/ajax.php?mobile_action=im&";this.pathToFileAjax=this.pathToAjax+"upload&";this.pathToBlankImage="/bitrix/js/im/images/blank.gif";this.notifyCount=e.notifyCount||0;this.messageCount=e.messageCount||0;this.messageCountArray={};this.settings=e.settings||{};this.settingsNotifyBlocked=e.settingsNotifyBlocked||{};this.timeoutUpdateCounters=null;this.timeoutUpdateStateLight=null;e.notify=e.notify||{};e.notify=e.message||{};e.notify=e.recent||{};for(var t in e.notify){e.notify[t].date=parseInt(e.notify[t].date)+parseInt(BX.message("USER_TZ_OFFSET"));if(parseInt(t)>this.lastRecordId)this.lastRecordId=parseInt(t)}for(var t in e.message){e.message[t].date=parseInt(e.message[t].date)+parseInt(BX.message("USER_TZ_OFFSET"));if(parseInt(t)>this.lastRecordId)this.lastRecordId=parseInt(t)}for(var t in e.recent){e.recent[t].date=parseInt(e.recent[t].date)+parseInt(BX.message("USER_TZ_OFFSET"))}this.notify=new BX.ImNotifyMobile(this,{counters:e.counters||{},notify:e.notify||{},unreadNotify:e.unreadNotify||{},flashNotify:e.flashNotify||{},countNotify:e.countNotify||0,loadNotify:e.loadNotify||false});this.disk=new BX.ImDiskManagerMobile(this,{notifyClass:this.notify,files:e.files||{},enable:e.disk&&e.disk.enable});this.notify.disk=this.disk;this.messenger=new BX.ImMessengerMobile(this,{updateStateInterval:e.updateStateInterval,notifyClass:this.notify,diskClass:this.disk,recent:e.recent||{},users:e.users||{},groups:e.groups||{},userChatBlockStatus:e.userChatBlockStatus||{},userInGroup:e.userInGroup||{},woGroups:e.woGroups||{},woUserInGroup:e.woUserInGroup||{},currentTab:e.currentTab||0,chat:e.chat||{},userInChat:e.userInChat||{},userChat:e.userChat||{},hrphoto:e.hrphoto||{},message:e.message||{},showMessage:e.showMessage||{},unreadMessage:e.unreadMessage||{},flashMessage:e.flashMessage||{},countMessage:e.countMessage||0,smile:e.smile||false,smileSet:e.smileSet||false,history:e.history||{}});this.notify.messenger=this.messenger;this.disk.messenger=this.messenger;this.webrtc=e.webrtc||{};this.messenger.webrtc=this.webrtc;if(this.init){BX.onCustomEvent(window,"onImMobileInit",[this]);app.pullDownLoadingStop();this.mobileActionPrepare(e)}if(this.mobileAction=="DIALOG"){BXMobileApp.UI.Page.TopBar.title.setText("");BXMobileApp.UI.Page.TopBar.title.setDetailText("");BXMobileApp.UI.Page.LoadingScreen.show()}BX.addCustomEvent("onFrameDataRequestFail",BX.delegate(function(e){this.mobileActionReady()},this));BX.addCustomEvent("onFrameDataProcessed",BX.delegate(function(e,t){for(var s=0;s<e.length;s++){if(e[s]["ID"].indexOf("im_component_")>=0){this.mobileActionFromCache()}}},this))};BX.ImMobile.prototype.openRecentList=function(){BXMobileApp.UI.Slider.setState(BXMobileApp.UI.Slider.state.CENTER);setTimeout(function(){BXMobileApp.UI.Slider.setState(BXMobileApp.UI.Slider.state.RIGHT)},500)};BX.ImMobile.prototype.mobileActionPrepare=function(e){if(this.mobileAction=="RECENT"){this.messenger.drawRecentList()}else if(this.mobileAction=="INIT"){this.initPageAction()}else if(this.mobileAction=="DIALOG"){this.dialogPageAction(e)}};BX.ImMobile.prototype.mobileActionFromCache=function(){if(this.mobileActionCache)return false;this.mobileActionCache=true;BX.addClass(document.body,"im-page-from-cache");if(this.mobileAction=="DIALOG"){this.messenger.currentTab=0;this.messenger.openChatFlag=false;this.messenger.openCallFlag=false;this.messenger.showMessage={};this.messenger.unreadMessage={}}this.mobileActionReady()};BX.ImMobile.prototype.mobileActionReady=function(){if(this.mobileActionRun)return false;this.mobileActionRun=true;BXMobileApp.UI.Page.LoadingScreen.hide();BX.removeClass(document.body,"im-page-from-cache");BX.MessengerCommon.pullEvent();if(this.mobileAction=="RECENT"){BX.addCustomEvent("onImDialogOpen",BX.delegate(function(e){this.messenger.openMessenger(e.id,false,false)},this));BX.addCustomEvent("onImDialogClose",BX.delegate(function(e){this.messenger.closeMessenger(e.id)},this));BX.addCustomEvent("onImDialogNetworkOpen",BX.delegate(function(e){for(var t=0;t<this.messenger.recent.length;t++){if(this.messenger.recent[t].userId==e.NETWORK_ID){this.messenger.recent[t].userId=e.USER_ID;this.messenger.recent[t].recipientId=e.USER_ID;this.messenger.recent[t].senderId=e.USER_ID}}this.messenger.users[e.USER_ID]=e.USER;this.messenger.currentTab=e.USER_ID;BX.MessengerCommon.userListRedraw()},this))}else if(this.mobileAction=="DIALOG"){BX.addCustomEvent("onOpenPageAfter",BX.delegate(function(){BX.MessengerCommon.readMessage(this.messenger.currentTab);this.messenger.dialogStatusRedraw();app.onCustomEvent("onImDialogOpen",{id:this.messenger.currentTab})},this));BX.addCustomEvent("onHidePageBefore",BX.delegate(function(){app.onCustomEvent("onImDialogClose",{id:this.messenger.currentTab})},this));BXMobileApp.UI.Page.TextPanel.setUseImageButton(true);BXMobileApp.UI.Page.TextPanel.setParams({callback:BX.delegate(function(e){if(e.event&&e.event=="onKeyPress"){if(BX.util.trim(e.text).length>2){BX.MessengerCommon.sendWriting(this.messenger.currentTab)}this.messenger.textareaHistory[this.messenger.currentTab]=e.text}},this),smileButton:{},placeholder:BX.message("IM_M_TEXTAREA"),mentionDataSource:{outsection:false,url:this.pathToRoot+"mobile/index.php?mobile_action=get_user_list&use_name_format=Y"},button_name:BX.message("IM_M_MESSAGE_SEND"),plusAction:!this.disk.enable?"":BX.delegate(function(){this.messenger.takePhotoMenu()},this),action:BX.delegate(function(e){this.messenger.textareaHistory[this.messenger.currentTab]="";this.messenger.sendMessage(this.messenger.currentTab,e);app.clearInput()},this)});BXMobileApp.UI.Page.TextPanel.show();app.enableCaptureKeyboard(true);BX.bind(window,"orientationchange",BX.delegate(function(){if(this.messenger.popupMessengerBody.scrollHeight-this.messenger.popupMessengerBody.scrollTop<window.screen.height)this.messenger.autoScroll()},this));BX.addCustomEvent("onKeyboardWillShow",BX.delegate(function(){this.keyboardShow=true;this.messenger.autoScroll()},this));BX.addCustomEvent("onKeyboardDidHide",BX.delegate(function(){this.keyboardShow=false},this));app.pullDown({enable:true,pulltext:BX.message("IM_M_DIALOG_PULLTEXT"),downtext:BX.message("IM_M_DIALOG_DOWNTEXT"),loadtext:BX.message("IM_M_DIALOG_LOADTEXT"),callback:BX.delegate(function(){BX.MessengerCommon.loadHistory(this.messenger.currentTab)},this)});BX.addCustomEvent("onPageParamsChanged",BX.delegate(function(e){this.messenger.openMessenger(e.dialogId)},this));if(BXMobileApp.apiVersion==1){this.messenger.openMessenger(this.messenger.currentTab)}else{BXMobileApp.UI.Page.params.get({callback:BX.delegate(function(e){this.messenger.openMessenger(e.dialogId)},this)})}BX.bindDelegate(this.messenger.popupMessengerBodyWrap,"click",{className:"bx-messenger-content-item-avatar-button"},BX.delegate(function(e){BX.localStorage.set("impmh",true,1);var t=BX.proxy_context.parentNode.parentNode.getAttribute("data-senderId");this.messenger.messageReply(t);return BX.PreventDefault(e)},this));BX.adjust(BX("im-dialog-form"),{children:[this.messenger.popupMessengerFileForm=BX.create("form",{attrs:{action:this.pathToFileAjax},props:{className:"bx-messenger-textarea-file-form"},children:[BX.create("input",{attrs:{type:"hidden",name:"IM_FILE_UPLOAD",value:"Y"}}),this.messenger.popupMessengerFileFormChatId=BX.create("input",{attrs:{type:"hidden",name:"CHAT_ID",value:0}}),this.messenger.popupMessengerFileFormRegChatId=BX.create("input",{attrs:{type:"hidden",name:"REG_CHAT_ID",value:0}}),this.messenger.popupMessengerFileFormRegMessageId=BX.create("input",{attrs:{type:"hidden",name:"REG_MESSAGE_ID",value:0}}),this.messenger.popupMessengerFileFormRegParams=BX.create("input",{attrs:{type:"hidden",name:"REG_PARAMS",value:""}}),BX.create("input",{attrs:{type:"hidden",name:"IM_AJAX_CALL",value:"Y"}}),this.messenger.popupMessengerFileFormInput=BX.create("input",{attrs:{type:"hidden",name:"FAKE_INPUT",value:"Y"}})]})]});this.disk.chatDialogInit();BX.bindDelegate(this.messenger.popupMessengerBodyWrap,"click",{className:"bx-messenger-content-item-like"},BX.delegate(function(e){var t=BX.proxy_context.parentNode.parentNode.parentNode.parentNode.getAttribute("data-blockmessageid");BX.MessengerCommon.messageLike(t);BX.localStorage.set("impmh",true,1);return BX.PreventDefault(e)},this));BX.bindDelegate(this.messenger.popupMessengerBodyWrap,"click",{tagName:"a"},BX.delegate(function(e){BX.localStorage.set("impmh",true,1)},this));BX.bindDelegate(this.messenger.popupMessengerBodyWrap,"click",{className:"bx-messenger-content-item-content"},BX.delegate(function(e){var t=BX.proxy_context.parentNode.getAttribute("data-blockmessageid");this.messenger.openMessageMenu(t)},this));BX.bindDelegate(this.messenger.popupMessengerBodyWrap,"click",{className:"bx-messenger-content-item-error"},BX.delegate(function(e){BX.localStorage.set("impmh",true,1);BX.MessengerCommon.sendMessageRetry();return BX.PreventDefault(e)},this))}};BX.ImMobile.prototype.initPageAction=function(e){BX.addCustomEvent("UIApplicationDidBecomeActiveNotification",BX.delegate(function(e){setTimeout(BX.delegate(this.updateStateLight,this),1e3)},this));BX.addCustomEvent("onImError",BX.delegate(function(e){if(e.error=="AUTHORIZE_ERROR"){app.BasicAuth({success:BX.delegate(function(){setTimeout(BX.delegate(this.updateStateLight,this),1e3)},this)})}else if(e.error=="RECENT_RELOAD"){app.BasicAuth({success:BX.delegate(function(){setTimeout(BX.delegate(this.updateStateLight,this),1e3)},this)})}},this));BX.addCustomEvent("onPullEvent-im",BX.delegate(function(e,t){if(e=="readMessage"){this.messageCountArray[t.userId]=0;this.updateCounter()}else if(e=="readMessageChat"){this.messageCountArray["chat"+t.chatId]=0;this.updateCounter()}else if(e=="chatUserLeave"){if(t.userId==BX.message("USER_ID")){this.messageCountArray["chat"+t.chatId]=0;this.updateCounter()}}else if(e=="readNotify"){this.notify.notifyLastId=parseInt(t.lastId);this.notifyCount=0;this.updateCounter()}else if(e=="message"||e=="messageChat"){var s=t.MESSAGE.senderId;if(s==BX.message("USER_ID")){this.messageCountArray[t.MESSAGE.recipientId]=0;this.updateCounter();return}if(e=="messageChat")s=t.MESSAGE.recipientId;if(typeof this.messageCountArray[s]!="undefined")this.messageCountArray[s]++;else this.messageCountArray[s]=1;app.getVar({"var":"PAGE_ID",from:"current",callback:BX.delegate(function(e){if(e=="DIALOG"+s)this.messageCountArray[s]=0;this.updateCounter()},this)})}else if(e=="notify"){lastId=parseInt(t.id);if(this.notify.notifyLastId<lastId)this.notify.notifyLastId=lastId;this.notifyCount++;this.updateCounter();if(!this.notify.notifyLoadFlag){clearTimeout(this.notifyTimeout);this.notifyTimeout=setTimeout(BX.delegate(function(){this.notify.notifyLoadFlag=true;app.refreshPanelPage("notifications")},this),600)}}},this));BX.addCustomEvent("onNotificationsLastId",BX.delegate(function(e){this.notify.notifyLoadFlag=false;e=parseInt(e);if(this.notify.notifyLastId<e)this.notify.notifyLastId=e},this));BX.addCustomEvent("onImDialogOpen",BX.delegate(function(e){this.messageCountArray[e.id]=0;this.updateCounter()},this));BX.addCustomEvent("onNotificationsOpen",BX.delegate(function(e){this.notify.notifyViewedWait()},this));BX.addCustomEvent("onOpenPush",BX.delegate(function(e){var t=BXMobileApp.PushManager.prepareParams(e);if(t.TAG){t.ACTION=t.TAG}if(t.ACTION.substr(0,8)=="IM_MESS_"){var s=parseInt(t.ACTION.substr(8));if(s>0){BXMobileApp.PageManager.loadPageUnique({url:this.pathToRoot+"mobile/im/dialog.php"+(!app.enableInVersion(11)?"?id="+s:""),bx24ModernStyle:true,data:{dialogId:s}})}}else if(t.ACTION.substr(0,8)=="IM_CHAT_"){var i=parseInt(t.ACTION.substr(8));if(i>0){BXMobileApp.PageManager.loadPageUnique({url:this.pathToRoot+"mobile/im/dialog.php"+(!app.enableInVersion(11)?"?id=chat"+i:""),bx24ModernStyle:true,data:{dialogId:"chat"+i}})}}else if(t.ACTION.substr(0,6)=="IMINV_"){var a=t.ACTION.split("_");var s=parseInt(a[1]);var o=parseInt(a[2]);if(!mwebrtc.timesUp(o*1e3)){mwebrtc.callInvite(s)}}},this));app.setPanelPages({messages_page:this.pathToRoot+"mobile/im/index.php?NEW",messages_open_empty:true,notifications_page:this.pathToRoot+"mobile/im/notify.php",notifications_open_empty:true});this.updateStateLight()};BX.ImMobile.prototype.dialogPageAction=function(e){this.messenger.popupMessengerBody=document.body;this.messenger.popupMessengerBodyWrap=BX("im-dialog-wrap");BX.addClass(this.messenger.popupMessengerBodyWrap,"bx-messenger-dialog-wrap");this.messenger.dialogOpen=true};BX.ImMobile.prototype.updateStateLight=function(){clearTimeout(this.timeoutUpdateStateLight);this.timeoutUpdateStateLight=setTimeout(BX.delegate(function(){BX.ajax({url:this.pathToAjax,method:"POST",dataType:"json",skipAuthCheck:true,timeout:20,data:{IM_UPDATE_STATE_LIGHT:"Y",MOBILE:"Y",SITE_ID:BX.message("SITE_ID"),NOTIFY:"Y",MESSAGE:"Y",IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){BX.onCustomEvent("onUpdateStateDone",[true]);BXMobileApp.onCustomEvent("onUpdateStateDone",true);if(e.ERROR.length==0){BX.message({SERVER_TIME:e.SERVER_TIME});if(BX.PULL&&e.PULL_CONFIG){BX.PULL.updateChannelID({METHOD:e.PULL_CONFIG.METHOD,CHANNEL_ID:e.PULL_CONFIG.CHANNEL_ID,CHANNEL_DT:e.PULL_CONFIG.CHANNEL_DT,PATH:e.PULL_CONFIG.PATH,LAST_ID:e.PULL_CONFIG.LAST_ID,PATH_WS:e.PULL_CONFIG.PATH_WS})}if(e.COUNTER_MESSAGES)this.messageCount=parseInt(e.COUNTER_MESSAGES);if(e.COUNTER_NOTIFICATIONS)this.notifyCount=parseInt(e.COUNTER_NOTIFICATIONS);if(e.NOTIFY_LAST_ID)this.notify.notifyLastId=parseInt(e.NOTIFY_LAST_ID);if(this.messageCount>0&&e.COUNTER_UNREAD_MESSAGES&&typeof e.COUNTER_UNREAD_MESSAGES=="object"){this.messageCount=0;this.messageCountArray={};for(var t in e.COUNTER_UNREAD_MESSAGES){this.messageCount+=e.COUNTER_UNREAD_MESSAGES[t].MESSAGE.counter;this.messageCountArray[t]=e.COUNTER_UNREAD_MESSAGES[t].MESSAGE.counter}BX.onCustomEvent("onUpdateUserCounters",[e.COUNTER_UNREAD_MESSAGES]);BXMobileApp.onCustomEvent("onUpdateUserCounters",e.COUNTER_UNREAD_MESSAGES)}else{this.messageCountArray={};BX.onCustomEvent("onUpdateUserCounters",[e.COUNTER_UNREAD_MESSAGES]);BXMobileApp.onCustomEvent("onUpdateUserCounters",e.COUNTER_UNREAD_MESSAGES)}this.updateCounter();if(e.COUNTERS&&typeof e.COUNTERS=="object"){var s=e.COUNTERS_ZERO_DATE&&typeof e.COUNTERS_ZERO_DATE=="object"?e.COUNTERS_ZERO_DATE:null;BX.onCustomEvent("onImUpdateCounter",[e.COUNTERS,s]);var i=BX.clone(e.COUNTERS);i.obZeroDate=s;setTimeout(function(){BXMobileApp.onCustomEvent("onImUpdateCounter",i)},3e3)}if(this.notifyCount>0&&!this.notify.notifyLoadFlag){clearTimeout(this.notifyTimeout);this.notifyTimeout=setTimeout(BX.delegate(function(){this.notify.notifyLoadFlag=true;app.refreshPanelPage("notifications")},this),600)}this.sendAjaxTry=0;if(BX.PULL){if(!BX.PULL.tryConnect()){BX.PULL.updateState(true)}}clearTimeout(this.timeoutUpdateStateLight);this.timeoutUpdateStateLight=setTimeout(BX.delegate(function(){this.updateStateLight()},this),8e4)}else if(e.ERROR=="AUTHORIZE_ERROR"&&this.sendAjaxTry<=3){this.sendAjaxTry++;BX.onCustomEvent("onImError",[{error:e.ERROR}]);BXMobileApp.onCustomEvent("onImError",{error:e.ERROR});clearTimeout(this.timeoutUpdateStateLight);this.timeoutUpdateStateLight=setTimeout(BX.delegate(function(){this.updateStateLight()},this),2e3)}else if(e.ERROR=="SESSION_ERROR"&&this.sendAjaxTry<=3){this.sendAjaxTry++;BX.message({bitrix_sessid:e.BITRIX_SESSID});clearTimeout(this.timeoutUpdateStateLight);this.timeoutUpdateStateLight=setTimeout(BX.delegate(function(){this.updateStateLight()},this),1e3)}else{this.sendAjaxTry=0}},this),onfailure:BX.delegate(function(e){BX.onCustomEvent("onUpdateStateDone",[false]);BXMobileApp.onCustomEvent("onUpdateStateDone",false);this.sendAjaxTry=0},this)})},this),300)};BX.ImMobile.prototype.updateCounter=function(){clearTimeout(this.timeoutUpdateCounters);this.timeoutUpdateCounters=setTimeout(BX.delegate(function(){this.messageCount=0;for(var e in this.messageCountArray)this.messageCount+=parseInt(this.messageCountArray[e]);BX.Menu.updateCounters({"im-message":this.messageCount});app.setBadge(parseInt(this.messageCount+this.notifyCount));app.setCounters({messages:this.messageCount,notifications:this.notifyCount})},this),500)};BX.ImMobile.prototype.isFocus=function(){return false};BX.ImMobile.prototype.isFocusMobile=function(e){BXMobileApp.UI.Page.isVisible({callback:BX.delegate(function(t){e(t.status=="visible")},this)});return null};BX.ImMobile.prototype.isMobile=function(){return false};BX.ImMobile.prototype.checkRevision=function(e){e=parseInt(e);if(typeof e=="number"&&this.revision<e){console.log("NOTICE: Window reload, because REVISION UP ("+this.revision+" -> "+e+")");BXMobileApp.UI.Page.reloadUnique();return false}return true}})();(function(){if(BX.ImMessengerMobile)return;BX.ImMessengerMobile=function(e,t){this.BXIM=e;this.settings={};this.params=t||{};this.notify=t.notifyClass;this.disk=t.diskClass;this.smile=t.smile;this.smileSet=t.smileSet;this.popupMessengerLikeBlock={};this.popupMessengerLikeBlockTimeout={};this.sendAjaxTry=0;this.updateStateStepDefault=this.BXIM.ppStatus?parseInt(t.updateStateInterval):60;this.updateStateStep=this.updateStateStepDefault;this.updateStateTimeout=null;this.readMessageTimeout={};this.readMessageTimeoutSend=null;this.realSearch=this.BXIM.bitrixNetwork2&&!this.BXIM.userExtranet||!this.BXIM.bitrixIntranet&&!this.BXIM.bitrix24net;this.realSearchFound=true;this.users=t.users;this.groups=t.groups;this.userInGroup=t.userInGroup;this.woGroups=t.woGroups;this.woUserInGroup=t.woUserInGroup;this.redrawTab={};this.loadLastMessageTimeout={};this.showMessage=t.showMessage;this.unreadMessage=t.unreadMessage;this.flashMessage=t.flashMessage;this.history=t.history||{};this.chat=t.chat;this.userChat=t.userChat;this.userInChat=t.userInChat;this.userChatBlockStatus=t.userChatBlockStatus;this.hrphoto=t.hrphoto;this.chatPublicWatch=0;this.chatPublicWatchAdd=false;this.dialogStatusRedrawTimeout=null;this.chatHeaderRedrawTimeout=null;this.textareaHistory={};this.mentionList={};this.mentionListen=false;this.mentionDelimiter="";this.phones={};this.errorMessage={};this.message=t.message;this.messageTmpIndex=0;this.messageCount=t.countMessage;this.sendMessageFlag=0;this.sendMessageTmp={};this.sendMessageTmpTimeout={};this.popupMessenger={fake:true};this.popupMessengerTextarea=null;this.openChatFlag=false;this.popupMessengerLastMessage=0;this.readedList={};this.writingList={};this.writingListTimeout={};this.writingSendList={};this.writingSendListTimeout={};this.contactListPanelStatus=null;this.contactListSearchText="";this.contactListSearchLastText="";this.popupContactListElementsWrap=null;this.popupContactListSearchInput=null;this.popupMessengerConnectionStatusState="online";this.popupMessengerConnectionStatusStateText="online";this.popupMessengerConnectionStatus=null;this.popupMessengerConnectionStatusText=null;this.popupMessengerConnectionStatusTimeout=null;this.recent=t.recent?t.recent:[];this.recentListLoad=t.recent?true:false;this.recentList=true;this.recentListReturn=false;this.recentListTab=null;this.recentListTabCounter=null;this.recentListIndex=[];this.currentTab=t.currentTab;this.contactList=false;this.contactListTab=null;this.contactListLoad=false;this.redrawContactListTimeout={};this.redrawRecentListTimeout=null;this.enableGroupChat=this.BXIM.ppStatus?true:false;this.historySearch="";this.historyOpenPage={};this.historyLoadFlag={};this.historyEndOfList={};this.popupMessengerBody=null;this.popupMessengerBodyDialog=null;this.popupMessengerBodyAnimation=null;this.popupMessengerBodySize=295;this.popupMessengerBodyWrap=null;this.popupMessengerFileForm=null;this.popupMessengerFileDropZone=null;this.popupMessengerFileButton=null;this.popupMessengerFileFormChatId=null;this.popupMessengerFileFormInput=null};BX.ImMessengerMobile.prototype.newMessage=function(){var e=[];var t=[];var s=0;var i={};for(var a in this.flashMessage){var o=false;var n=false;if(a==this.currentTab){o=true}else if(a.toString().substr(0,4)=="chat"&&this.userChatBlockStatus[a.substr(4)]&&this.userChatBlockStatus[a.substr(4)][this.BXIM.userId]=="Y"){n=true}if(o||n){for(var r in this.flashMessage[a]){if(this.flashMessage[a][r]!==false){this.flashMessage[a][r]=false;s++}}continue}for(var r in this.flashMessage[a]){if(this.flashMessage[a][r]!==false){var l=this.message[r].recipientId.toString().substr(0,4)=="chat";var h=this.message[r].recipientId;var p=!l&&this.message[r].senderId==0?a:this.message[r].senderId;var u=this.message[r].text_mobile?this.message[r].text_mobile:this.message[r].text;if(a!=this.BXIM.userId){i[a]=l?this.chat[h.substr(4)].name:this.users[p].name}u=u.replace(/------------------------------------------------------(.*?)------------------------------------------------------/gim,"["+BX.message("IM_M_QUOTE_BLOCK")+"]");if(u.length>150){u=u.substr(0,150);var m=u.lastIndexOf(" ");if(m<140)u=u.substr(0,m)+"...";else u=u.substr(0,140)+"..."}if(u==""&&this.message[r].params["FILE_ID"].length>0){u="["+BX.message("IM_F_FILE")+"]"}u=u.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/gi,function(e,t,s){return s});u=u.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/gi,function(e,t,s){return s});t.push({id:l?h:p,title:l?this.chat[h.substr(4)].name:this.users[p].name,text:(l&&p>0?this.users[p].name+": ":"")+u,icon:l?this.chat[h.substr(4)].avatar:this.users[p].avatar,tag:"im-messenger-"+(l?h:p)});this.flashMessage[a][r]=false}}}if(t.length>2){var g=t.length;var d="";for(var a in i)d+=", <i>"+i[a]+"</i>";t=[];t.push({id:"im-common",title:BX.message("IM_NM_MESSAGE_1").replace("#COUNT#",g),icon:"",text:BX.message("IM_NM_MESSAGE_2").replace("#USERS#",BX.util.htmlspecialcharsback(d.substr(2))).replace(/<\/?[^>]+>/gi,""),tag:"im-messenger"})}else if(t.length==0){return false}for(var a=0;a<t.length;a++){var c=function(){};if(t[a].tag=="im-messenger"){c=function(){BXMobileApp.UI.Slider.setState(BXMobileApp.UI.Slider.state.RIGHT)}}else{c=BX.proxy(function(e){this.openMessenger(e.extra.dialogId)},this)}new BXMobileApp.UI.NotificationBar({message:"<b>"+t[a].title+"</b><br>"+t[a].text,contentType:"html",color:"#af000000",textColor:"#ffffff",groupId:t[a].tag,maxLines:4,align:"left",imageURL:t[a].icon,imageBorderRadius:50,indicatorHeight:30,isGlobal:true,useCloseButton:true,autoHideTimeout:5e3,hideOnTap:true,onTap:c,extra:{dialogId:t[a].id}},t[a].id).show()}};BX.ImMessengerMobile.prototype.drawRecentList=function(){app.pullDown({enable:true,pulltext:BX.message("IM_PULLDOWN_RL_1"),downtext:BX.message("IM_PULLDOWN_RL_2"),loadtext:BX.message("IM_PULLDOWN_RL_3"),callback:function(){app.BasicAuth({success:function(){BX.onCustomEvent("onImError",[{error:"RECENT_RELOAD"}]);BXMobileApp.onCustomEvent("onImError",{error:"RECENT_RELOAD"});BX.frameCache.update();app.pullDownLoadingStop()},failture:function(){app.pullDownLoadingStop()}})}});this.popupContactListSearchInput=BX("im-contact-list-search");this.popupContactListSearchInput.innerHTML="";BX.addClass(this.popupContactListSearchInput,"bx-messenger-cl-wrap");BX.unbindAll(this.popupContactListSearchInput);BX.adjust(this.popupContactListSearchInput,{children:[this.popupContactListSearchWrap=BX.create("div",{props:{className:"bx-messenger-cl-search"},children:[BX.create("div",{props:{className:"bx-messenger-input-wrap bx-messenger-cl-search-wrap"},children:[this.popupContactListSearchClose=BX.create("span",{props:{className:"bx-messenger-input-close"}}),this.popupContactListSearchInput=BX.create("input",{attrs:{type:"text",placeholder:BX.message("IM_SEARCH_PLACEHOLDER_CP"),value:this.contactListSearchText},props:{className:"bx-messenger-input"}})]})]})]});BX.bind(this.popupContactListSearchInput,"keyup",BX.delegate(function(e){BX.MessengerCommon.contactListSearch(e)},this));this.popupContactListElementsWrap=BX("im-contact-list-wrap");this.popupContactListElementsWrap.innerHTML="";BX.unbindAll(this.popupContactListElementsWrap);BX.addClass(this.popupContactListElementsWrap,"bx-messenger-recent-wrap");BitrixMobile.fastClick.bindDelegate(this.popupContactListElementsWrap,{className:"bx-messenger-cl-item"},BX.delegate(BX.MessengerCommon.contactListClickItem,BX.MessengerCommon));BitrixMobile.fastClick.bindDelegate(this.popupContactListElementsWrap,{className:"bx-messenger-cl-group-title"},BX.delegate(BX.MessengerCommon.contactListToggleGroup,BX.MessengerCommon));BX.bind(this.popupContactListSearchClose,"click",BX.delegate(BX.MessengerCommon.contactListSearchClear,BX.MessengerCommon));if(this.recent.length==0){BX.MessengerCommon.contactListRedraw()}else{BX.MessengerCommon.userListRedraw()}};BX.ImMessengerMobile.prototype.openPhotoGallery=function(e){var t=BX.findChildrenByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-file-image-text");var s=[];var i="";var a="";for(var o=0;o<t.length;o++){a=t[o].getAttribute("src");s.push({url:a.replace("preview=Y&",""),description:t[o].innerHTML});if(e&&a.indexOf(e)>-1)i=a.replace("preview=Y&","")}if(s.length>0){BX.localStorage.set("impmh",true,1);BXMobileApp.UI.Photo.show({photos:s,default_photo:i})}};BX.ImMessengerMobile.prototype.dialogStatusRedraw=function(e){var t=e&&e.type?parseInt(e.type):"none";clearTimeout(this.dialogStatusRedrawTimeout);this.dialogStatusRedrawTimeout=setTimeout(BX.delegate(function(){this.dialogStatusRedrawDelay(e)},this),200)};BX.ImMessengerMobile.prototype.dialogStatusRedrawDelay=function(e){e=e||{};if(this.currentTab==0)return false;this.openChatFlag=false;this.openCallFlag=false;if(this.currentTab.toString().substr(0,4)=="chat"){this.openChatFlag=true;if(this.chat[this.currentTab.toString().substr(4)]&&this.chat[this.currentTab.toString().substr(4)].type=="call")this.openCallFlag=true}if(this.openChatFlag){var t=this.currentTab.toString().substr(4);if(this.chat[t]&&this.chat[t].type!="call"){var s=this.userChatBlockStatus[t]&&this.userChatBlockStatus[t][this.BXIM.userId]=="Y"?BX.message("IM_CHAT_MUTE_ON"):BX.message("IM_CHAT_MUTE_OFF");app.menuCreate({items:[{icon:"glasses",name:s,action:BX.delegate(function(){BX.MessengerCommon.muteMessageChat(this.currentTab.toString().substr(4))},this)},{icon:"user",name:BX.message("IM_M_MENU_USERS"),action:BX.delegate(function(){BXMobileApp.PageManager.loadPageUnique({url:this.BXIM.pathToRoot+"mobile/im/chat.php?chat_id="+this.currentTab.toString().substr(4),bx24ModernStyle:true,data:{dialogId:this.currentTab}})},this)},{icon:"add",name:BX.message("IM_M_MENU_ADD"),action:BX.delegate(function(){this.extendChat(this.currentTab,true)},this)},{icon:"reload",name:BX.message("IM_M_MENU_RELOAD"),action:function(){BXMobileApp.UI.Page.TopBar.title.setText("");BXMobileApp.UI.Page.TopBar.title.setDetailText("");BXMobileApp.UI.Page.reloadUnique()}}]})}else{app.menuCreate({items:[{icon:"reload",name:BX.message("IM_M_MENU_RELOAD"),action:function(){BXMobileApp.UI.Page.TopBar.title.setText("");BXMobileApp.UI.Page.TopBar.title.setDetailText("");BXMobileApp.UI.Page.reloadUnique()}}]})}if(this.chat[t]){var i=this.chat[t].extranet?"#e8a441":this.chat[t].color;app.exec("setTopBarColors",{background:i,titleText:"#ffffff",titleDetailText:"#f0f0f0"})}}else if(this.currentTab){var a=this.currentTab;app.menuCreate({items:[{icon:"user",name:BX.message("IM_M_MENU_USER"),action:BX.delegate(function(){app.loadPageBlank({url:this.BXIM.path.profileTemplate.replace("#user_id#",this.currentTab),bx24ModernStyle:true})},this)},{icon:"add",name:BX.message("IM_M_MENU_ADD"),action:BX.delegate(function(){this.extendChat(this.currentTab,false)},this)},{icon:"reload",name:BX.message("IM_M_MENU_RELOAD"),action:function(){BXMobileApp.UI.Page.TopBar.title.setText("");BXMobileApp.UI.Page.TopBar.title.setDetailText("");BXMobileApp.UI.Page.reloadUnique()}}]});if(this.users[a]){var i=this.users[a].extranet?"#e8a441":this.users[a].color;app.exec("setTopBarColors",{background:i,titleText:"#ffffff",titleDetailText:"#f0f0f0"})}}if(app.enableInVersion(10)){if(this.openChatFlag&&this.chat[t]){BXMobileApp.UI.Page.TopBar.title.setText(this.chat[t].name);BXMobileApp.UI.Page.TopBar.title.setImage(BX.MessengerCommon.isBlankAvatar(this.chat[t].avatar)?"":this.chat[t].avatar);if(this.chat[t].type=="call"){BXMobileApp.UI.Page.TopBar.title.setDetailText(BX.message("IM_VI_CALL"))}else{if(this.userInChat[t])BXMobileApp.UI.Page.TopBar.title.setDetailText(BX.message("IM_M_MENU_USERS")+": "+this.userInChat[t].length)}}else{BXMobileApp.UI.Page.TopBar.title.setText(this.users[a].name);BXMobileApp.UI.Page.TopBar.title.setImage(BX.MessengerCommon.isBlankAvatar(this.users[a].avatar)?"":this.users[a].avatar);BXMobileApp.UI.Page.TopBar.title.setDetailText(this.users[a].workPosition)}BXMobileApp.UI.Page.TopBar.title.setCallback(function(){app.menuShow()});BXMobileApp.UI.Page.TopBar.title.show()}else{app.addButtons({addRefreshButton:{type:"context-menu",style:"custom",callback:function(){app.menuShow()}}})}if(this.popupMessengerFileFormChatId){if(this.openChatFlag)this.popupMessengerFileFormChatId.value=t;else this.popupMessengerFileFormChatId.value=this.userChat[this.currentTab]?this.userChat[this.currentTab]:0}if(!e.slidingPanelRedrawDisable&&(a>0&&!this.users[a].fake||t>0&&!this.chat[t].fake)){var o=false;var n={};if(this.openChatFlag){if(this.openCallFlag){o=true;n["button_2"]={name:BX.message("IM_PHONE_CALL"),type:"call_audio",callback:BX.delegate(function(){document.location.href="tel:"+this.chat[t].call_number},this)}}else{app.hideButtonPanel()}}else if(this.webrtc.mobileSupport&&app.enableInVersion(10)&&!this.users[a].network){o=true;if(this.webrtc.mobileSupport&&app.enableInVersion(9)){n["button_1"]={name:BX.message("IM_VIDEO_CALL"),type:"call_video",callback:function(){app.onCustomEvent("onCallInvite",{userId:a})}}}var r=BX.MessengerCommon.countObject(this.phones[a]);if(r>0){var l=[];l.push({title:BX.message("IM_AUDIO_CALL"),callback:BX.delegate(function(){app.onCustomEvent("onCallInvite",{userId:a,video:false})},this)});if(this.phones[a].PERSONAL_MOBILE){l.push({title:BX.message("IM_PHONE_MOB")+": "+this.phones[a].PERSONAL_MOBILE,callback:BX.delegate(function(){document.location.href="tel:"+this.phones[a].PERSONAL_MOBILE},this)})}if(this.phones[a].WORK_PHONE){l.push({title:BX.message("IM_PHONE_WORK")+": "+this.phones[a].WORK_PHONE,callback:BX.delegate(function(){document.location.href="tel:"+this.phones[a].WORK_PHONE},this)})}if(this.phones[a].PERSONAL_PHONE){l.push({title:BX.message("IM_PHONE_DEF")+": "+this.phones[a].PERSONAL_PHONE,callback:BX.delegate(function(){document.location.href="tel:"+this.phones[a].PERSONAL_PHONE},this)})}if(l.length>1){var h=new BXMobileApp.UI.ActionSheet({buttons:l},"call_audio");n["button_2"]={name:BX.message("IM_PHONE_CALL"),type:"call_audio",callback:function(){h.show()}}}else{n["button_2"]={name:BX.message("IM_AUDIO_CALL"),type:"call_audio",
callback:function(){app.onCustomEvent("onCallInvite",{userId:a,video:false})}}}}else{n["button_2"]={name:BX.message("IM_AUDIO_CALL"),type:"call_audio",callback:function(){app.onCustomEvent("onCallInvite",{userId:a,video:false})}}}}else if(this.webrtc.mobileSupport&&app.enableInVersion(9)&&!this.users[a].network){o=true;n["button_1"]={name:BX.message("IM_VIDEO_CALL"),type:"call_video",callback:function(){app.onCustomEvent("onCallInvite",{userId:a})}};n["button_2"]={name:BX.message("IM_AUDIO_CALL"),type:"call_audio",callback:function(){app.onCustomEvent("onCallInvite",{userId:a,video:false})}}}if(o){app.showSlidingPanel({hidden_sliding_panel:false,buttons:n})}}};BX.ImMessengerMobile.prototype.autoScroll=function(){if(document.body.scrollHeight<=window.innerHeight)return false;this.popupMessengerBody.scrollTop=this.popupMessengerBody.scrollHeight;return true};BX.ImMessengerMobile.prototype.takePhotoMenu=function(){if(!this.openChatFlag&&this.users[this.currentTab].network){app.alert({text:BX.message("IM_F_NW20_NOT_SUPPORT")});return false}var e=new BXMobileApp.UI.ActionSheet({buttons:[{title:BX.message("IM_MENU_UPLOAD_PHOTO"),callback:BX.delegate(function(){app.takePhoto({quality:80,source:1,correctOrientation:true,targetWidth:1024,targetHeight:1024,destinationType:Camera.DestinationType.DATA_URL,callback:BX.delegate(this.disk.uploadFromMobile,this.disk)})},this)},{title:BX.message("IM_MENU_UPLOAD_GALLERY"),callback:BX.delegate(function(){app.takePhoto({quality:80,targetWidth:1024,targetHeight:1024,destinationType:Camera.DestinationType.DATA_URL,callback:BX.delegate(this.disk.uploadFromMobile,this.disk)})},this)}]},"textPanelSheet");e.show()};BX.ImMessengerMobile.prototype.updateChatAvatar=function(e,t){if(!this.openChatFlag)return false;var s=this.currentTab.toString().substr(4);if(e!=s)return false;if(app.enableInVersion(10)){BXMobileApp.UI.Page.TopBar.title.setImage(BX.MessengerCommon.isBlankAvatar(t)?"":t)}};BX.ImMessengerMobile.prototype.redrawChatHeader=function(){clearTimeout(this.chatHeaderRedrawTimeout);this.chatHeaderRedrawTimeout=setTimeout(BX.delegate(function(){this.redrawChatHeaderDelay()},this),200)};BX.ImMessengerMobile.prototype.redrawChatHeaderDelay=function(){if(!this.openChatFlag)return false;var e=this.currentTab.toString().substr(4);if(!this.chat[e])return false;if(this.popupMessengerFileFormChatId){this.popupMessengerFileFormChatId.value=e}if(app.enableInVersion(10)){BXMobileApp.UI.Page.TopBar.title.setText(this.chat[e].name);BXMobileApp.UI.Page.TopBar.title.setImage(BX.MessengerCommon.isBlankAvatar(this.chat[e].avatar)?"":this.chat[e].avatar);if(this.chat[e].type=="call"){BXMobileApp.UI.Page.TopBar.title.setDetailText(BX.message("IM_VI_CALL"))}else{if(this.userInChat[e])BXMobileApp.UI.Page.TopBar.title.setDetailText(BX.message("IM_M_MENU_USERS")+": "+this.userInChat[e].length)}}var t=this.chat[e].extranet?"#e8a441":this.chat[e].color;app.exec("setTopBarColors",{background:t,titleText:"#ffffff",titleDetailText:"#f0f0f0"})};BX.ImMessengerMobile.prototype.extraClose=function(){app.closeController()};BX.ImMessengerMobile.prototype.openMessenger=function(e,t,s){if(this.BXIM.mobileAction=="RECENT"){s=s!==false;if(this.currentTab!=e){var i=BX.findChild(this.popupContactListElementsWrap,{attribute:{"data-userId":this.currentTab}},false);if(i){BX.removeClass(i,"bx-messenger-cl-item-active")}if(!t){i=BX.findChild(this.popupContactListElementsWrap,{attribute:{"data-userId":e}},false);if(i){t=i}}if(t){BX.addClass(t,"bx-messenger-cl-item-active")}this.currentTab=e}if(s){BXMobileApp.PageManager.loadPageUnique({url:this.BXIM.pathToRoot+"mobile/im/dialog.php"+(!app.enableInVersion(11)?"?id="+this.currentTab:""),bx24ModernStyle:true,data:{dialogId:this.currentTab}})}}else if(this.BXIM.mobileAction=="DIALOG"){if(!this.BXIM.messenger.redrawTab[e]&&this.currentTab==e&&this.popupMessengerBodyWrap.innerHTML!="")return false;if(typeof e=="undefined"||e==null)e=0;if(e==this.BXIM.userId){this.currentTab=0;e=0}if(this.currentTab==null)this.currentTab=0;this.openChatFlag=false;this.openNetworkFlag=false;this.openCallFlag=false;if(e.toString().substr(0,4)=="chat"){this.openChatFlag=true;BX.MessengerCommon.getUserParam(e);if(this.chat[e.toString().substr(4)]&&this.chat[e.toString().substr(4)].type=="call")this.openCallFlag=true}else if(e.toString().substr(0,7)=="network"){this.openNetworkFlag=true;BX.MessengerCommon.getUserParam(e)}else if(this.users[e]&&this.users[e].id){e=parseInt(e)}else{e=parseInt(e);if(isNaN(e)){e=0}else{BX.MessengerCommon.getUserParam(e)}}if(this.openNetworkFlag){}else if(!this.openChatFlag&&typeof e!="number"){e=0}if(e==0){this.openChatFlag=false;app.closeController()}else if(this.openChatFlag||this.openNetworkFlag||e>0){this.currentTab=e;BX.MessengerCommon.openDialog(this.currentTab)}}};BX.ImMessengerMobile.prototype.closeMessenger=function(e){e=e?e:this.currentTab;this.currentTab=0;this.openChatFlag=false;var t=BX.findChild(this.popupContactListElementsWrap,{attribute:{"data-userId":e}},false);if(t){if(BX.hasClass(t,"bx-messenger-cl-item-active")){BX.removeClass(t,"bx-messenger-cl-item-active")}}};BX.ImMessengerMobile.prototype.closeMenuPopup=function(){};BX.ImMessengerMobile.prototype.sendMessage=function(e,t){e=typeof e=="string"||typeof e=="number"?e:this.currentTab;BX.MessengerCommon.endSendWriting(e);t=t.replace("    ","	");t=BX.util.trim(t);if(t.length==0)return false;if(t.indexOf("/color")==0){var s=t.split(" ")[1];if(s&&this.openChatFlag){BX.MessengerCommon.setColor(s,e.substr(4))}return false}else if(t.indexOf("/rename")==0){var i=t.substr(7);if(i&&this.openChatFlag){BX.MessengerCommon.renameChat(e.substr(4),i)}return false}var a=e.toString().substr(0,4)=="chat"?e.toString().substr(4):this.userChat[e]?this.userChat[e]:0;if(this.errorMessage[e]){BX.MessengerCommon.sendMessageRetry();this.errorMessage[e]=false}var o=this.messageTmpIndex;this.message["temp"+o]={id:"temp"+o,chatId:a,senderId:this.BXIM.userId,recipientId:e,date:BX.MessengerCommon.getNowDate(),text:BX.MessengerCommon.prepareText(t,true)};if(!this.showMessage[e])this.showMessage[e]=[];this.showMessage[e].push("temp"+o);this.messageTmpIndex++;BX.localStorage.set("mti",this.messageTmpIndex,5);if(e!=this.currentTab)return false;clearTimeout(this.textareaHistoryTimeout);var n=BX.findChildByClassName(this.popupMessengerBodyWrap,"bx-messenger-content-load");if(n)BX.remove(n);var r=BX.findChildByClassName(this.popupMessengerBodyWrap,"bx-messenger-content-empty");if(r)BX.remove(r);BX.MessengerCommon.drawMessage(e,this.message["temp"+o]);this.textareaHistory[e]="";BX.MessengerCommon.sendMessageAjax(o,e,t,e.toString().substr(0,4)=="chat");return true};BX.ImMessengerMobile.prototype.setUpdateStateStep=function(){};BX.ImMessengerMobile.prototype.setUpdateStateStepCount=function(){};BX.ImMessengerMobile.prototype.extendChat=function(e,t){app.openTable({url:this.BXIM.pathToRoot+"mobile/index.php?mobile_action=get_user_list",callback:BX.delegate(function(s){if(!(s&&s.a_users&&s.a_users[0]))return;var i=[];for(var a=0;a<s.a_users.length;a++)i.push(s.a_users[a]["ID"].toString());var s=false;if(!t){i.push(e);s={IM_CHAT_ADD:"Y",USERS:JSON.stringify(i),IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}}else{s={IM_CHAT_EXTEND:"Y",CHAT_ID:e.substr(4),USERS:JSON.stringify(i),IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}}if(!s)return false;BX.ajax({url:this.BXIM.pathToRoot+"mobile/ajax.php?mobile_action=im&"+(t?"CHAT_EXTEND":"CHAT_ADD"),method:"POST",dataType:"json",timeout:60,data:s,onsuccess:BX.delegate(function(e){if(e.ERROR==""){if(!t&&e.CHAT_ID){BXMobileApp.PageManager.loadPageUnique({url:this.BXIM.pathToRoot+"mobile/im/dialog.php"+(!app.enableInVersion(11)?"?id=chat"+e.CHAT_ID:""),bx24ModernStyle:true,data:{dialogId:"chat"+e.CHAT_ID}})}}else{app.alert({text:e.ERROR})}},this)})},this),set_focus_to_search:true,markmode:true,multiple:true,return_full_mode:true,modal:true,alphabet_index:true,outsection:false,okname:BX.message("IM_M_EXTEND")})};BX.ImMessengerMobile.prototype.messageReply=function(e){if(!this.users[e]||this.users[e].fake)return false;var t=BX.util.htmlspecialcharsback(this.users[e].name);t=t+", ";if(!this.textareaHistory[this.currentTab])this.textareaHistory[this.currentTab]="";this.textareaHistory[this.currentTab]=this.textareaHistory[this.currentTab]+" "+t;BXMobileApp.UI.Page.TextPanel.setText(this.textareaHistory[this.currentTab]);BXMobileApp.UI.Page.TextPanel.focus()};BX.ImMessengerMobile.prototype.openMessageMenu=function(e){if(!this.message[e]||this.BXIM.keyboardShow||BX.localStorage.get("impmh"))return false;var t=BX.MessengerCommon.messageIsLike(e);var s=[];s.push({title:BX.message(t?"IM_MENU_MESS_DISLIKE":"IM_MENU_MESS_LIKE"),callback:BX.delegate(function(){BX.MessengerCommon.messageLike(e)},this)});var i=this.message[e].senderId;if(i>0){s.push({title:BX.message("IM_MENU_MESS_REPLY"),callback:BX.delegate(function(){this.messageReply(i)},this)})}var a=0;var o=BX("im-message-"+e);if(o){var n=BX.findChildrenByClassName(o.parentNode.parentNode,"bx-messenger-message");for(var r=n.length-1;r>=0&&a==0;r--){if(!BX.hasClass(n[r],"bx-messenger-message-deleted")){a=n[r].id.substr(11)}}}if(BX.MessengerCommon.checkEditMessage(a)){if(app.enableInVersion(14)&&window.platform!="android"){s.push({title:BX.message("IM_MENU_MESS_EDIT"),callback:BX.delegate(function(){this.editMessage(a)},this)})}s.push({title:BX.message("IM_MENU_MESS_DEL"),callback:BX.delegate(function(){this.deleteMessage(a)},this)})}var l=new BXMobileApp.UI.ActionSheet({buttons:s},"im-message-menu");l.show()};BX.ImMessengerMobile.prototype.editMessage=function(e,t){if(!BX.MessengerCommon.checkEditMessage(e))return false;var s={mentionButton:{dataSource:{return_full_mode:"YES",outsection:"NO",multiple:"NO",alphabet_index:"YES",url:BX.message("MobileSiteDir")+"mobile/index.php?mobile_action=get_user_list"}},smileButton:{},message:{text:BX.MessengerCommon.prepareTextBack(this.message[e].text,true)},okButton:{callback:function(t){BX.MessengerCommon.editMessageAjax(e,t.text)},name:BX.message("IM_MENU_SAVE")},cancelButton:{callback:BX.delegate(function(){this.editMessageCancel()},this),name:BX.message("IM_MENU_CANCEL")}};app.exec("showPostForm",s)};BX.ImMessengerMobile.prototype.editMessageCancel=function(){this.keyboardShow=false};BX.ImMessengerMobile.prototype.deleteMessage=function(e,t){if(!BX.MessengerCommon.checkEditMessage(e))return false;if(t!==false){var s=this.message[e].text.length>50?this.message[e].text.substr(0,47)+"...":this.message[e].text;app.confirm({title:BX.message("IM_MENU_MESS_DEL_CONFIRM"),text:'"'+s+'"',buttons:[BX.message("IM_MENU_MESS_DEL_YES"),BX.message("IM_MENU_MESS_DEL_NO")],callback:function(t){if(t==1){BX.MessengerCommon.deleteMessageAjax(e)}}})}else{this.deleteMessageAjax(e)}}})();(function(){if(BX.ImNotifyMobile)return;BX.ImNotifyMobile=function(e,t){this.BXIM=e;this.sendAjaxTry=0;this.notifyLastId=0;this.notifyLoadFlag=false;this.timeoutNotifyViewedWait=null};BX.ImNotifyMobile.prototype.notifyViewedWait=function(){clearTimeout(this.timeoutNotifyViewedWait);if(!this.notifyLoadFlag){this.timeoutNotifyViewedWait=setTimeout(BX.delegate(this.notifyViewed,this),300);this.BXIM.notifyCount=0;this.BXIM.updateCounter()}else{clearTimeout(this.timeoutNotifyViewedWait);this.timeoutNotifyViewedWait=setTimeout(BX.delegate(this.notifyViewedWait,this),2e3)}};BX.ImNotifyMobile.prototype.notifyViewed=function(){if(parseInt(this.notifyLastId)<=0)return false;BX.ajax({url:this.BXIM.pathToAjax,method:"POST",dataType:"json",skipAuthCheck:true,data:{IM_NOTIFY_VIEWED:"Y",MAX_ID:parseInt(this.notifyLastId),IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(function(e){if(e.ERROR.length==0){this.sendAjaxTry=0;this.notifyLastId=0}else if(e.ERROR=="AUTHORIZE_ERROR"&&this.sendAjaxTry<=3){this.sendAjaxTry++;BX.onCustomEvent("onImError",[{error:e.ERROR}]);BXMobileApp.onCustomEvent("onImError",{error:e.ERROR});setTimeout(BX.delegate(function(){this.notifyViewed()},this),2e3)}else if(e.ERROR=="SESSION_ERROR"&&this.sendAjaxTry<=3){this.sendAjaxTry++;BX.message({bitrix_sessid:e.BITRIX_SESSID});setTimeout(BX.delegate(function(){this.notifyViewed()},this),1e3)}else{this.sendAjaxTry=0}},this),onfailure:BX.delegate(function(e){this.sendAjaxTry=0},this)});return true}})();(function(){if(BX.ImDiskManagerMobile)return;BX.ImDiskManagerMobile=function(e,t){this.BXIM=e;this.notify=t.notifyClass;this.enable=t.enable;this.lightVersion=false;this.formBlocked={};this.formAgents={};this.files=t.files;this.filesProgress={};this.filesMessage={};this.filesRegister={};this.fileTmpId=1;this.timeout={};BX.garbage(function(){var e={};var t=0;for(var s in this.filesMessage){e[s]=this.filesMessage[s];if(this.messenger.message[e[s]]){t=this.messenger.message[e[s]].chatId}}if(t>0){BX.ajax({url:this.BXIM.pathToFileAjax+"?FILE_TERMINATE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,async:false,data:{IM_FILE_UNREGISTER:"Y",CHAT_ID:t,FILES:JSON.stringify(this.filesProgress),MESSAGES:JSON.stringify(e),IM_AJAX_CALL:"Y",sessid:BX.bitrix_sessid()}})}},this)};BX.ImDiskManagerMobile.prototype.chatDialogInit=function(){this.formAgents["imDialog"]=BX.Uploader.getInstance({id:"imDialog",allowUpload:"A",uploadMethod:"deferred",uploadFormData:"Y",showImage:true,filesInputMultiple:true,uploadFileUrl:this.BXIM.pathToFileAjax,input:null,fields:{preview:{params:{width:212,height:119}}}});this.formAgents["imDialog"].form=this.messenger.popupMessengerFileForm;BX.addCustomEvent(this.formAgents["imDialog"],"onError",BX.delegate(BX.MessengerCommon.diskChatDialogUploadError,BX.MessengerCommon));BX.addCustomEvent(this.formAgents["imDialog"],"onFileIsInited",BX.delegate(function(e,t,s){BX.MessengerCommon.diskChatDialogFileInited(e,t,s);BX.addCustomEvent(t,"onUploadStart",BX.delegate(BX.MessengerCommon.diskChatDialogFileStart,BX.MessengerCommon));BX.addCustomEvent(t,"onUploadProgress",BX.delegate(BX.MessengerCommon.diskChatDialogFileProgress,BX.MessengerCommon));BX.addCustomEvent(t,"onUploadDone",BX.delegate(BX.MessengerCommon.diskChatDialogFileDone,BX.MessengerCommon));BX.addCustomEvent(t,"onUploadError",BX.delegate(BX.MessengerCommon.diskChatDialogFileError,BX.MessengerCommon))},this))};BX.ImDiskManagerMobile.prototype.uploadFromMobile=function(e){var t=BX.UploaderUtils.dataURLToBlob("data:image/png;base64,"+e);t.name="mobile_"+BX.date.format("Ymd_His")+".png";this.formAgents["imDialog"].onChange([t])};BX.ImDiskManagerMobile.prototype.diskChatDialogFileInited=function(e,t,s){var i=s.form.CHAT_ID.value;if(!this.files[i])this.files[i]={};this.files[i][e]={id:e,tempId:e,chatId:i,date:BX.MessengerCommon.getNowDate(),type:t.isImage?"image":"file",preview:t.isImage?t.canvas:"",name:t.name,size:t.file.size,status:"upload",progress:-1,authorId:this.BXIM.userId,authorName:this.messenger.users[this.BXIM.userId].name,urlPreview:"",urlShow:"",urlDownload:""};if(!this.filesRegister[i])this.filesRegister[i]={};this.filesRegister[i][e]={id:e,type:this.files[i][e].type,mimeType:t.file.type,name:this.files[i][e].name,size:this.files[i][e].size};BX.MessengerCommon.diskChatDialogFileRegister(i)};BX.ImDiskManagerMobile.prototype.saveToDisk=function(){return true};BX.ImDiskManagerMobile.prototype.delete=function(){return true}})();
//# sourceMappingURL=mobile.map.js